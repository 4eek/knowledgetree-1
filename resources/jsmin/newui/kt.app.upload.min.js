if(typeof kt.app=="undefined")kt.app={};
kt.app.upload=new function(){this.data={};this.data.files={};var h=this.fragmentPackage=[this.fragments=["upload/upload.dialog","upload/upload.dialog.item","upload/upload.dialog.item.nobulk","upload/upload.metadata.fieldset"]],c=this.execPackage=[this.execs=["upload/upload.doctypes","upload/upload.metadata.dialog"]],b=this;this.elems={};this.uploadfolder=this.uploader=null;this.init=function(){kt.api.preload(h,c,true)};this.uploadWindow=null;this.addUpload=function(a,d){var e={},f=1;if(b.data.applyMetaDataToAll&&
b.data.globalMetaData!=undefined){e=b.data.globalMetaData.metadata;f=b.data.globalMetaData.docTypeID;d=!b.data.globalMetaDataRequiredDone}var j=kt.api.getUserType("upload/upload.dialog.item")==4?jQuery(kt.api.getFragment("upload/upload.dialog.item.nobulk")):jQuery(kt.api.getFragment("upload/upload.dialog.item"));jQuery(b.elems.item_container).append(j);a.length>50&&jQuery(".ul_filename").addClass("ellipsis");e=new b.uploadStructure({fileName:a+"",elem:j,metadata:e,docTypeId:f,has_required_metadata:d,
required_metadata_done:!d,parent:b});kt.lib.meta.set(j[0],"item",e);e.startUpload();b.data.files[a]=e;var i=a.lastIndexOf(".");f=a.substr(i).toLowerCase();j=kt.lib.meta.get(j[0],"item");if(f==".gz"||f==".bz2"){i=a.substring(0,i);var m=i.lastIndexOf(".");if(i.substr(m).toLowerCase()!=".tar")return e}this.isBulkExtension(f)&&jQuery("#"+j.options.elem[0].id+" .ul_bulk_checkbox").css("display","block");return e};this.isBulkExtension=function(a){for(var d=[".ar",".bz",".bz2",".deb",".gz",".rar",".tgz",
".tar",".tbz",".zip"],e=false,f=0;f<d.length;f++)if(d[f]==a){e=true;break}return e};this.getItem=function(a){a=jQuery(a).parents(".ul_item")[0];return kt.lib.meta.get(a,"item")};this.getMetaItem=function(a){a=jQuery(a).parents(".metadataTable")[0];return kt.lib.meta.get(a,"item")};this.applyMetadataToAll=function(a,d,e){if(a){b.data.applyMetaDataToAll=true;b.data.globalMetaData=d;jQuery.each(b.data.files,function(f,j){j.options.metadata=d.metadata;j.options.required_metadata_done=e})}else{b.data.applyMetaDataToAll=
false;b.data.globalMetaData={}}b.data.globalMetaDataRequiredDone=e};this.findItem=function(a){if(typeof b.data.files[a]!="undefined")return b.data.files[a];return null};this.getNodeTxt=function(a){return nodeText=strpos(a,"<")==false?trim(a):trim(a.substr(0,strpos(a,"<")))};this.getNodePath=function(a){nodeInTree=jQuery("ul#loadedpath li[folderid="+a+"]");if(a==1)pathToItem=" / (Root Directory)";else{pathToItem=kt.app.upload.getNodeTxt(nodeInTree.html());nodeInTree.parentsUntil("#loadedpath").each(function(){if(jQuery(this).get(0).tagName==
"LI")pathToItem=jQuery(this).attr("folderid")==1?"/"+pathToItem:kt.app.upload.getNodeTxt(jQuery(this).html())+"/"+pathToItem})}return pathToItem};this.loadFolderPath=function(a){html='<ul id="currentPathStuff">';currentNode=jQuery("ul#loadedpath li[folderid="+a+"]");if(a+""!="1")html+='<li class="folder_up" folderid="'+currentNode.parent().parent().attr("folderid")+'">[Folder Up]</li>';if(currentNode.length!=0)if(currentNode.hasClass("loadedchildren")){childItems=jQuery("ul#loadedpath li[folderid="+
a+"]>ul");childItems.length!=0&&childItems.children().each(function(){child=jQuery(this);nodeText=kt.app.upload.getNodeTxt(child.html());html+='<li folderid="'+child.attr("folderid")+'">'+nodeText+"</li>"});html+="</ul>";jQuery("#folderpathchooser").html(html)}else{jQuery("#folderpathchooser").html('<div class="loading"></div>');kt.api.getSubFolders(a,function(d){if(d.data.children.length!=0){parentUl=jQuery("ul#loadedpath li[folderid="+a+"] > ul");if(parentUl.length==0)parentUl=jQuery("ul#loadedpath li[folderid="+
a+"]").append("<ul></ul>");jQuery.each(d.data.children,function(e,f){jQuery("ul#loadedpath li[folderid="+a+"] > ul > li[folderid="+f.id+"]").length==0&&jQuery("ul#loadedpath li[folderid="+a+"] > ul").append('<li class="notloaded" folderid="'+f.id+'">'+f.name+"</li>");html+='<li folderid="'+f.id+'">'+f.name+"</li>"})}jQuery("ul#loadedpath li[folderid="+a+"]").removeClass("notloaded").addClass("loadedchildren");html+="</ul>";jQuery("#folderpathchooser").html(html)},function(){})}};this.addDocuments=
function(){var a=window.location.pathname.indexOf("dashboard")>0,d=false;this.hideWindow();filesToAdd={};var e=0,f=false,j=false,i=jQuery("#currentPath").val();jQuery.each(b.data.files,function(m,l){if(!d){d=true;kt.app.upload.unhideProgressWidget()}if(l.options.is_uploaded){var k=l.options.fileName,n=l.options.do_bulk_upload;if(n)j=true;else f=true;var p=l.options.docTypeId,o={},g=0;jQuery.each(l.options.metadata,function(q,r){o[g++]={id:q,value:r}});k=encodeURIComponent(k);var s=b.data.s3TempPath+
k;filesToAdd[e++]={baseFolderID:b.data.baseFolderID,fileName:k,folderID:i,docTypeID:p,metadata:o,s3TempFile:s,doBulk:n}}});kt.api.addDocuments(filesToAdd,function(m){var l=false;try{jQuery.each(m.data.addedDocuments,function(p,o){var g=jQuery.parseJSON(o);if(g.error)l=true;else if(g.success){delete b.data.files[g.success.filename];if(!g.success.isBulk&&!a&&g.success.baseFolderID==i){g={id:g.success.id,is_immutable:false,is_checkedout:false,filename:g.success.filename,filesize:g.success.filesize,document_url:g.success.document_url,
title:g.success.title,owned_by:g.success.owned_by,created_by:g.success.created_by,created_date:g.success.created_date,modified_by:g.success.modified_by,modified_date:g.success.modified_date,mimeicon:g.success.mimeicon,allowdoczohoedit:g.success.allowdoczohoedit,isfinalize_document:g.success.isfinalize_document,user_id:g.success.user_id,item_type:g.success.item_type,thumbnail:"",thumbnailclass:"nopreview"};jQuery(".page .notification").remove();kt.pages.browse.addDocumentItem(g)}}});kt.lib.setFooter();
if(f&&j)var k="Files added. E-mail link to files sent.";else if(f)k="Files added.";else if(j)k=" E-mail link to files sent.";kt.app.upload.updateProgress(k,false);kt.app.upload.fadeProgress(1E4);if(l){k="One or more files failed to upload.";kt.app.upload.updateProgress(k,true);jQuery("#uploadProgress").fadeIn();kt.app.upload.fadeProgress(1E4)}}catch(n){kt.app.upload.fadeProgress(1E4)}},function(){},e*3E4);this.closeWindow()};this.closeWindow=function(){uploadWindow=Ext.getCmp("extuploadwindow");b.data=
{};b.data.files={};uploadWindow.destroy()};this.hideWindow=function(){uploadWindow=Ext.getCmp("extuploadwindow");uploadWindow.hide()};this.enableAddButton=function(){jQuery("#ul_actions_upload_btn").removeAttr("disabled")};this.disableAddButton=function(){jQuery("#ul_actions_upload_btn").attr("disabled","true")};this.unhideProgressWidget=function(){var a=jQuery(".uploadProgress");a.removeClass("error");a.text("Adding files ...");a.css("display","block");a.css("visibility","visible");a.append('<img src="/resources/graphics/newui/large-loading.gif" style="float: right;"/>')};
this.updateProgress=function(a,d){var e=jQuery(".uploadProgress");if(e!=null)if(isNaN(a))e.text(a);else a<=100&&e.text(a+"%");d?e.addClass("error"):e.removeClass("error")};this.fadeProgress=function(a){jQuery("#uploadProgress").fadeOut(a)};this.allFilesReadyForUpload=function(){var a=true;jQuery.each(b.data.files,function(d,e){e.options.is_uploaded||(a=false)});return a};this.showUploadWindow=function(){var a=false;b.data={};b.data.files={};kt.api.docTypeHasRequiredFields("1",function(e){a=e.data.hasRequiredFields});
var d=new Ext.Window({id:"extuploadwindow",layout:"fit",width:520,resizable:false,closable:true,closeAction:"destroy",y:50,autoScroll:false,bodyCssClass:"ul_win_body",cls:"ul_win",shadow:true,modal:true,title:"Upload Files",html:kt.api.getFragment("upload/upload.dialog")});d.addListener("show",function(){kt.app.upload.disableAddButton();b.elems.item_container=jQuery(".uploadTable .ul_list")[0];b.elems.qq=jQuery("#upload_add_file .qq-uploader")[0];b.uploader=new qq.FileUploader({element:document.getElementById("upload_add_file"),
params:{},buttonText:"Choose File",allowedExtensions:[],sizeLimit:0,multiple:false,onSubmit:function(e,f){jQuery(".no_files_selected").css("display","none");kt.app.upload.disableAddButton();b.addUpload(f,a)},onComplete:function(e,f){try{b.findItem(f).completeUpload()}catch(j){}},showMessage:function(e){alert(e)}});jQuery("input[name='fFolderId']").length==0?jQuery("#currentPath").val(1):jQuery("#currentPath").val(jQuery("input[name='fFolderId']").val());kt.api.getFolderHierarchy(jQuery("#currentPath").val(),
function(e){if(jQuery("#currentPath").val()==1)jQuery("ul#loadedpath").append('<li class="loadedchildren" folderid="'+jQuery("#currentPath").val()+'">'+e.data.currentFolder.name+"</li>");else{jQuery.each(e.data.parents,function(j,i){i.parent_id==null?jQuery("ul#loadedpath").append('<li class="notloaded" folderid="'+i.id+'">'+i.name+"</li>"):jQuery("ul#loadedpath li[folderid="+i.parent_id+"]").append('<ul><li class="notloaded" folderid="'+i.id+'">'+i.name+"</li></ul>")});jQuery("ul#loadedpath li[folderid="+
e.data.currentFolder.parent_id+"]").append('<ul><li class="loadedchildren" folderid="'+jQuery("#currentPath").val()+'">'+e.data.currentFolder.name+"</li></ul>")}parentNode=jQuery("ul#loadedpath li[folderid="+jQuery("#currentPath").val()+"] ul");if(parentNode.length==0)parentNode=jQuery("ul#loadedpath li[folderid="+jQuery("#currentPath").val()+"]").append("<ul></ul>");jQuery.each(e.data.children,function(j,i){jQuery("ul#loadedpath li[folderid="+jQuery("#currentPath").val()+"] ul").append('<li class="notloaded" folderid="'+
i.id+'">'+i.name+"</li>")});var f=kt.app.upload.getNodePath(jQuery("#currentPath").val());if(f.length>45)f=".../"+f.substr(f.length-45,45);jQuery("#uploadpathstring").html(f);jQuery("#changepathlink").show();b.uploader.setParams({AWSAccessKeyId:e.data.amazoncreds.AWSAccessKeyId,acl:e.data.amazoncreds.acl,key:e.data.amazoncreds.awstmppath+"${filename}",policy:e.data.amazoncreds.policy,"Content-Type":"binary/octet-stream",signature:e.data.amazoncreds.signature,success_action_redirect:e.data.amazoncreds.success_action_redirect});
b.data.s3TempPath=e.data.amazoncreds.awstmppath;b.uploader._options.action=e.data.amazoncreds.formAction;b.uploader._handler._options.action=e.data.amazoncreds.formAction},function(){});jQuery("#changepathlink").live("click",function(){jQuery("#folderpathchooser").toggle();if(jQuery("#folderpathchooser").css("display")=="none")jQuery("#changepathlink").html("Change");else{jQuery("#changepathlink").html("Done");kt.app.upload.loadFolderPath(jQuery("#currentPath").val())}});jQuery("#folderpathchooser li").live("click",
function(){node=jQuery(this);jQuery("#currentPath").val(node.attr("folderid"));jQuery("#uploadpathstring").html(kt.app.upload.getNodePath(node.attr("folderid")));kt.app.upload.loadFolderPath(node.attr("folderid"))})});b.uploadWindow=d;d.show();b.data.baseFolderID=jQuery("#currentPath").val()};this.init()};
kt.app.upload.uploadStructure=function(h){var c=this;h=c.options=kt.lib.Object.extend({is_uploaded:false,has_required_metadata:false,required_metadata_done:false,do_bulk_upload:false,elem:null,docTypeId:1,docTypeFieldData:null,metadata:{},parent:null,fields_required:{}},h);this.init=function(){c.setFileName(c.options.fileName)};this.setFileName=function(b){jQuery(".ul_filename",c.options.elem).html(b)};this.setProgress=function(b,a){a=kt.lib.Object.ktenum(a,"uploading,waiting,ui_meta,add_doc,done",
"waiting");var d=jQuery(".ul_progress",c.options.elem);d.html(b);a=="uploading"?jQuery(".ul_progress_spinner",c.options.elem).css("visibility","visible"):jQuery(".ul_progress_spinner",c.options.elem).css("visibility","hidden");if(a=="ui_meta"){jQuery(d).css("cursor","pointer");jQuery(d).one("click",function(){c.showMetadataWindow()})}else{jQuery(d).css("cursor","default");jQuery(d).unbind()}jQuery(c.options.elem).removeClass("ul_f_uploading ul_f_waiting ul_f_ui_meta ul_f_add_doc ul_f_done").addClass("ul_f_"+
a)};this.startUpload=function(){c.setProgress("Uploading","uploading")};this.completeUpload=function(){c.options.is_uploaded=true;if(c.options.has_required_metadata&&!c.options.required_metadata_done)c.setProgress("Edit properties","ui_meta");else{c.setProgress("Ready to add","waiting");kt.app.upload.allFilesReadyForUpload()?kt.app.upload.enableAddButton():kt.app.upload.disableAddButton()}};this.setDocType=function(b){c.options.docTypeId=b;c.options.docTypeFieldData=kt.api.docTypeFields(b)};this.setMetaData=
function(b,a){c.options.metadata[b]=a};this.getMetaData=function(b){return value=c.options.metadata[b]};this.removeItem=function(){jQuery("#"+c.options.elem[0].id).remove();delete c.options.parent.data.files[c.options.fileName];if(jQuery.isEmptyObject(c.options.parent.data.files)){jQuery(".no_files_selected").css("display","block");kt.app.upload.disableAddButton()}else kt.app.upload.allFilesReadyForUpload()?kt.app.upload.enableAddButton():kt.app.upload.disableAddButton()};this.setAsBulk=function(){c.options.do_bulk_upload=
jQuery("#"+c.options.elem[0].id+" .ul_bulk_checkbox input#unzip_checkbox").attr("checked")?true:false};this.showMetadataWindow=function(){var b=new Ext.Window({layout:"fit",width:400,resizable:false,closable:false,closeAction:"destroy",y:50,autoScroll:false,bodyCssClass:"ul_meta_body",cls:"ul_meta",shadow:true,modal:true,title:"Document Properties",html:kt.api.execFragment("upload/upload.metadata.dialog")});b.addListener("close",function(){var a=c.checkRequiredFieldsCompleted();c.options.required_metadata_done=
a;a=jQuery("#ul_meta_actionbar_apply_to_all")[0].checked;kt.app.upload.applyMetadataToAll(a,{docTypeID:c.options.docTypeId,metadata:c.options.metadata},c.options.required_metadata_done);var d=true;jQuery.each(c.options.parent.data.files,function(e,f){if(f.options.has_required_metadata)if(f.options.required_metadata_done)f.setProgress("Ready to add","waiting");else{f.setProgress("Edit properties","ui_meta");d=false}else d=true});d?kt.app.upload.enableAddButton():kt.app.upload.disableAddButton();c.options.fields_required=
{}});c.options.metaWindow=b;b.show();b=jQuery(".metadataTable")[0];c.options.metaDataTable=b;kt.lib.meta.set(b,"item",c);if(c.options.parent!=null)if(c.options.parent.data.applyMetaDataToAll&&c.options.parent.data.globalMetaData!=undefined)jQuery("#ul_meta_actionbar_apply_to_all")[0].checked=true;c.changeDocType(c.options.docTypeId?c.options.docTypeId:1)};this.registerRequiredFieldNotDone=function(b){c.options.fields_required[b]=false};this.registerRequiredFieldDone=function(b){c.options.fields_required[b]=
true};this.checkRequiredFieldsCompleted=function(){var b=true;jQuery.each(c.options.fields_required,function(a,d){d||(b=false)});return b};this.changeDocType=function(b){c.options.docTypeId=b;c.options.fields_required={};kt.api.docTypeHasRequiredFields(b,function(g){docTypeHasRequiredFields=g.data.hasRequiredFields;c.options.has_required_metadata=docTypeHasRequiredFields});try{for(var a=jQuery(".ul_doctype",c.options.metaDataTable)[0],d=0;d<a.options.length;d++)if(a.options[d].value==b)a.selectedIndex=
d;var e=kt.api.docTypeFields(b);c.options.docTypeFieldData=e.fieldsets;var f=jQuery(".ul_metadata",c.options.metaDataTable);f.html("");if(!(e.fieldsets instanceof Array))for(d in c.options.docTypeFieldData){var j=c.options.docTypeFieldData[d].properties,i=c.options.docTypeFieldData[d].fields,m=jQuery(kt.lib.String.parse(kt.api.getFragment("upload/upload.metadata.fieldset"),j));f.append(m);for(var l in i){var k=i[l],n="upload/upload.metadata.field."+c.getFieldType(k),p=jQuery(kt.lib.String.parse(kt.api.getFragment(n),
k));m.append(p)}}}catch(o){}};this.getFieldType=function(b){var a=(""+b.data_type).toLowerCase();if(a=="string"){if(b.has_inetlookup==1)return b.inetlookup_type;if(b.has_lookuptree==1)return"tree";if(b.has_lookup==1)return"lookup"}if(a=="large text"){if(b.is_html==1)return"large-html";return"large-text"}return a};this.init(h)};function strpos(h,c,b){h=(h+"").indexOf(c,b||0);return h===-1?false:h}
function trim(h,c){var b,a=0,d=0;h+="";if(c){c+="";b=c.replace(/([\[\]\(\)\.\?\/\*\{\}\+\$\^\:])/g,"$1")}else b=" \n\r\t\u000c\u000b\u00a0\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u200b\u2028\u2029\u3000";a=h.length;for(d=0;d<a;d++)if(b.indexOf(h.charAt(d))===-1){h=h.substring(d);break}a=h.length;for(d=a-1;d>=0;d--)if(b.indexOf(h.charAt(d))===-1){h=h.substring(0,d+1);break}return b.indexOf(h.charAt(0))===-1?h:""};
